{% extends "base.html" %}
{% block content %}

<div class="d-flex align-items-end justify-content-between flex-wrap gap-2 mb-3">
  <div>
    <h3 class="section-title mb-1">АУ-12 №{{ object.number }}</h3>
    <div class="text-muted">
      Дата: {{ object.date }} · ССПС: {{ object.ssps_unit }} · Этап: {{ object.get_step_display }}
    </div>
  </div>
  <span class="badge-soft">{{ object.get_status_display }}</span>
</div>

<div class="card p-4 mb-3">
  <h5 class="mb-3">Предпросмотр листа</h5>

  <div class="border rounded-3 p-3">
    <div class="fw-semibold mb-2">Маршрутный лист формы АУ-12</div>
    <div class="mb-2">№ {{ object.number }} от {{ object.date }}</div>

    <div class="row g-2 mb-3">
      <div class="col-md-3"><span class="text-muted">Дорога:</span> {{ object.railway_name|default:"—" }}</div>
      <div class="col-md-3"><span class="text-muted">Предприятие:</span> {% if object.enterprise %}{{ object.enterprise.name }} {% else  %} - {% endif %}</div>
      <div class="col-md-3"><span class="text-muted">ССПС:</span> {{ object.ssps_unit }}</div>
      <div class="col-md-3"><span class="text-muted">Бригада:</span> {% if object.brigade %}{{ object.brigade.name }}{% else %}—{% endif %}</div>
    </div>

    <div class="fw-semibold mb-2">Раздел I. Бригада</div>
    <div class="table-responsive mb-3">
      <table class="table table-sm align-middle">
        <thead>
          <tr>
            <th>Должность</th><th>ФИО</th><th>Явка</th><th>Оконч.</th><th>Перер.</th><th>Отдых</th>
          </tr>
        </thead>
        <tbody>
        {% for r in object.crew_rows.all %}
          <tr>
            <td>{{ r.position_display }}</td>
            <td>{{ r.full_name }}</td>
            <td>{% if r.time_check_in %}{{ r.time_check_in }}{% endif %}</td>
            <td>{% if r.time_check_out %}{{ r.time_check_out }}{% endif %}</td>
            <td>{{ r.overtime_minutes }}</td>
            <td>{{ r.rest_minutes }}</td>
          </tr>
        {% empty %}
          <tr><td colspan="6" class="text-muted">Нет данных</td></tr>
        {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="fw-semibold mb-2">Раздел II. Пробег и ТСМ</div>
    {% if object.section_ii %}
      <div class="row g-2 mb-2">
        <div class="col-md-6"><span class="text-muted">Предприятие-владелец:</span> {% if object.section_ii.transport and object.section_ii.transport.ssps_unit and object.section_ii.transport.ssps_unit.owner %}{{ object.section_ii.transport.ssps_unit.owner.name }}{% else %}—{% endif %}</div>
        <div class="col-md-4"><span class="text-muted">Тип машины:</span> {% if object.section_ii.machine_type %}{{ object.section_ii.machine_type.name }}{% else %}—{% endif %}</div>
        <div class="col-md-2"><span class="text-muted">Номер:</span> {% if object.section_ii.transport %}{{ object.section_ii.transport.number }}{% else %}—{% endif %}</div>      </div>
      <div class="row g-2 mb-2">
        <div class="col-md-6"><span class="text-muted">Спидометр:</span> {{ object.section_ii.speedometer_out_km }} / {{ object.section_ii.speedometer_in_km }}</div>
        <div class="col-md-6"><span class="text-muted">Моточасы:</span> {{ object.section_ii.moto_hours_out }} / {{ object.section_ii.moto_hours_in }}</div>
      </div>
      <div class="row g-2 mb-3">
        <div class="col-md-3"><span class="text-muted">Топливо:</span> {{ object.section_ii.fuel_type|default:"—" }}</div>
        <div class="col-md-3"><span class="text-muted">Выдано:</span> {{ object.section_ii.fuel_issued_l }}</div>
        <div class="col-md-3"><span class="text-muted">Ост. выезд:</span> {{ object.section_ii.fuel_left_out_l }}</div>
        <div class="col-md-3"><span class="text-muted">Ост. возврат:</span> {{ object.section_ii.fuel_left_in_l }}</div>
      </div>
    {% else %}
      <div class="text-muted mb-3">Раздел II не заполнен.</div>
    {% endif %}

    <div class="fw-semibold mb-2">Раздел III. Работы</div>
    <div class="table-responsive mb-3">
      <table class="table table-sm align-middle">
        <thead>
          <tr>
            <th>№</th><th>Станция от</th><th>Станция до</th><th>Отпр.</th><th>Приб.</th><th>Работы</th><th>Место</th>
          </tr>
        </thead>
        <tbody>
        {% for w in object.work_rows.all %}
          <tr>
            <td>{{ w.request_no }}</td>
            <td>{% if w.station_from %}{{ w.station_from }}{% endif %}</td>
            <td>{% if w.station_to %}{{ w.station_to }}{% endif %}</td>
            <td>{% if w.time_departure %}{{ w.time_departure }}{% endif %}</td>
            <td>{% if w.time_arrival %}{{ w.time_arrival }}{% endif %}</td>
            <td>{{ w.work_name|default:"—" }}</td>
            <td>{{ w.work_place|default:"—" }}</td>
          </tr>
        {% empty %}
          <tr><td colspan="7" class="text-muted">Нет данных</td></tr>
        {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="fw-semibold mb-2">Раздел IV–VI</div>
    <div class="row g-2 mb-3">
      <div class="col-md-4">
        <div class="border rounded-3 p-2 h-100">
          <div class="text-muted">Раздел IV — результаты работы и расход ТСМ</div>
          {% if object.section_iv %}
            <div class="small">Состояние: {{ object.section_iv.technical_state|default:"—" }}</div>
            <div class="small">Неисправности: {{ object.section_iv.defects_found|default:"—" }}</div>
            <div class="small">Меры: {{ object.section_iv.measures_taken|default:"—" }}</div>
          {% else %}
            <div>—</div>
          {% endif %}
        </div>
      </div>
      <div class="col-md-4">
        <div class="border rounded-3 p-2 h-100">
          <div class="text-muted">Раздел V — тех. состояние и допуски</div>
          {% if object.section_v %}
            <div class="small">Допуски/примечания: {{ object.section_v.fuel_notes|default:"—" }}</div>
            <div class="small">Связь/устройства: {{ object.section_v.repairs_notes|default:"—" }}</div>
            <div class="small">Ответственный: {{ object.section_v.master_name|default:"—" }}</div>
          {% else %}
            <div>—</div>
          {% endif %}
        </div>
      </div>
      <div class="col-md-4">
        <div class="border rounded-3 p-2 h-100">
          <div class="text-muted">Раздел VI — замечания</div>
          {% if object.section_vi %}
            <div class="small">{{ object.section_vi.final_notes|default:"—" }}</div>
            <div class="small">Проверил: {{ object.section_vi.inspector_name|default:"—" }}</div>
          {% else %}
            <div>—</div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="fw-semibold mb-2">Медосмотр</div>
    {% if object.medical %}
      <div class="row g-2">
        <div class="col-md-6">
          <span class="text-muted">До:</span>
          {% if object.medical.pre_time %}{{ object.medical.pre_time }}{% endif %}
          · допуск: {% if object.medical.pre_allowed %}ДА{% else %}НЕТ{% endif %}
          · медик: {{ object.medical.pre_medic_name }}
        </div>
        <div class="col-md-6">
          <span class="text-muted">После:</span>
          {% if object.medical.post_time %}{{ object.medical.post_time }}{% endif %}
          · допуск: {% if object.medical.post_allowed %}ДА{% else %}НЕТ{% endif %}
          · медик: {{ object.medical.post_medic_name }}
        </div>
      </div>
    {% else %}
      <div class="text-muted">Нет данных медосмотра.</div>
    {% endif %}
  </div>
</div>

<div class="card p-4 mb-3">
  <h5 class="mb-3">Действия</h5>

  <div class="d-flex flex-wrap gap-2 mb-3">
    {% if can_med_pre %}
      <a class="btn btn-brand" href="{% url 'routesheets:au12_med_pre' object.id %}">Медосмотр (до)</a>
    {% endif %}

    {% if can_issue %}
      <form method="post" action="{% url 'routesheets:au12_issue' object.id %}">
        {% csrf_token %}
        <button class="btn btn-brand" type="submit">Мастер: выдать (с предзаполнением)</button>
      </form>
    {% endif %}

    {% if can_med_post %}
      <a class="btn btn-brand" href="{% url 'routesheets:au12_med_post' object.id %}">Медосмотр (после)</a>
    {% endif %}

    {% if can_finalize %}
      <form method="post" action="{% url 'routesheets:au12_finalize' object.id %}">
        {% csrf_token %}
        <button class="btn btn-brand" type="submit">Закрыть лист</button>
      </form>
    {% endif %}
  </div>

  <div class="d-flex flex-wrap gap-2 mb-3">
    <a class="btn btn-ghost" href="{% url 'routesheets:au12_sec_i' object.id %}">Заполнить Раздел I</a>
    <a class="btn btn-ghost" href="{% url 'routesheets:au12_sec_ii' object.id %}">Заполнить Раздел II</a>
    <a class="btn btn-ghost" href="{% url 'routesheets:au12_sec_iii' object.id %}">Заполнить Раздел III</a>
    <a class="btn btn-ghost" href="{% url 'routesheets:au12_sec_iv' object.id %}">Заполнить Раздел IV</a>
    <a class="btn btn-ghost" href="{% url 'routesheets:au12_sec_v' object.id %}">Заполнить Раздел V</a>
    <a class="btn btn-ghost" href="{% url 'routesheets:au12_sec_vi' object.id %}">Заполнить Раздел VI</a>
  </div>

  <div class="d-flex flex-wrap gap-2">
    <a class="btn btn-ghost" href="{% url 'routesheets:au12_export_pdf' object.id %}">Экспорт PDF</a>
    <a class="btn btn-ghost" href="{% url 'routesheets:au12_export_excel' object.id %}">Экспорт Excel</a>
    <a class="btn btn-ghost" href="{% url 'routesheets:au12_list' %}">К списку</a>
  </div>
</div>

{% endblock %}
